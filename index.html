<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PALAZZO MOLTENI TOKYO | Virtual Tour Suite</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Libre+Bodoni:wght@400;700&display=swap');
        :root { --accent: #007AFF; --grey: #86868B; --border: #D2D2D7; --bodoni: 'Libre Bodoni', serif; --panel-w: 350px; }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #fff; font-family: -apple-system, sans-serif; overflow: hidden; color: #000; -webkit-font-smoothing: antialiased; }

        /* --- HEADER & FOOTER --- */
        header { position: fixed; top: 0; width: 100%; height: 85px; background: rgba(255,255,255,0.95); backdrop-filter: blur(15px); z-index: 2000; border-bottom: 1px solid #eee; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .brand-title { font-family: var(--bodoni); font-size: 22px; letter-spacing: 0.15em; text-transform: uppercase; }
        .location { font-size: 9px; letter-spacing: 0.4em; color: var(--grey); text-transform: uppercase; margin-top: 6px; }

        footer { position: fixed; bottom: 0; width: 100%; height: 85px; background: #000; display: flex; z-index: 3000; }
        .floor-btn { flex: 1; color: #fff; text-align: center; padding: 18px 0; opacity: 0.35; cursor: pointer; border: none; background: none; }
        .floor-btn.active { opacity: 1; }
        .floor-num { display: block; font-family: var(--bodoni); font-size: 24px; }
        .floor-label { display: block; font-size: 8px; text-transform: uppercase; letter-spacing: 0.1em; color: #888; }

        /* --- VIEWPORT --- */
        #viewport { width: 100%; height: 100%; padding: 85px 0 85px 0; box-sizing: border-box; overflow-y: auto; overflow-x: hidden; position: relative; z-index: 100; transition: 0.5s; touch-action: pan-y; }
        body.pinning-mode-active #viewport { width: calc(100% - var(--panel-w)); transform: translateX(var(--panel-w)); }

        .area-nav { display: flex; gap: 35px; padding: 25px 40px; overflow-x: auto; background: #fff; border-bottom: 1px solid #f2f2f2; scrollbar-width: none; position: sticky; top: 0; z-index: 500; }
        .area-nav::-webkit-scrollbar { display: none; }
        .area-item { font-size: 13px; text-transform: uppercase; letter-spacing: 0.2em; color: var(--grey); cursor: pointer; white-space: nowrap; padding-bottom: 8px; border-bottom: 2px solid transparent; transition: 0.3s; }
        .area-item.active { color: #000; font-weight: bold; border-bottom-color: #000; }

        .nav-arrow { position: fixed; top: 50%; transform: translateY(-50%); width: 54px; height: 54px; display: flex; align-items: center; justify-content: center; z-index: 1500; cursor: pointer; color: rgba(0,0,0,0.5); background: rgba(255,255,255,0.4); backdrop-filter: blur(5px); border-radius: 50%; transition: 0.3s; pointer-events: auto; }
        .nav-arrow:hover { color: rgba(0,0,0,1); background: rgba(255,255,255,0.8); }
        .arrow-left { left: 25px; } .arrow-right { right: 25px; }

        .scene-wrap { width: 100%; position: relative; line-height: 0; font-size: 0; }
        /* 100%幅設定 */
        .scene-wrap img { width: 100%; height: auto; display: block; border-radius: 0; }

        /* PIN DESIGN */
        .mol-hs { position: absolute; transform: translate(-50%, -50%); text-decoration: none; z-index: 10; display: block; }
        .mol-dot-outer { width: 12px; height: 12px; background: rgba(255,255,255,0.2); border: 1px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .mol-dot-inner { width: 4px; height: 4px; border: 1px solid #fff; border-radius: 50%; }
        .type-detail .mol-dot-outer, .type-detail .mol-dot-inner { border-radius: 0; }
        .mol-card { position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%); background: #fff; padding: 12px 18px; border-radius: 2px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: max-content; max-width: 220px; opacity: 0; visibility: hidden; transition: 0.3s; text-align: center; line-height: 1.5; color: #000; }
        .mol-card strong { font-family: var(--bodoni); font-size: 12px; display: block; text-transform: uppercase; margin-bottom: 4px; }
        .mol-card span { font-size: 9px; color: var(--grey); font-weight: bold; display: block; }
        .mol-hs:hover .mol-card, .mol-hs:active .mol-card { opacity: 1; visibility: visible; bottom: 30px; }
        .mol-hs:hover .mol-dot-outer { background: rgba(255,255,255,0.6); transform: scale(1.1); }

        /* DESIGNER UI */
        #ui-mode-toggle { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; background: rgba(255,255,255,0.9); padding: 4px; border: 1px solid var(--border); border-radius: 2px; }
        #ui-mode-toggle button { border: none; background: none; padding: 8px 18px; font-size: 10px; font-weight: bold; cursor: pointer; }
        #ui-mode-toggle button.active { background: #000; color: #fff; }
        #admin-panel { position: fixed; top: 0; left: -400px; width: var(--panel-w); height: 100%; background: #fff; z-index: 5000; transition: 0.5s; padding: 40px 30px; box-sizing: border-box; overflow-y: auto; border-right: 1px solid #eee; }
        #admin-panel.open { left: 0; }
        .pin-switch { margin-bottom: 15px; padding: 15px; border: 1px solid #000; text-align: center; cursor: pointer; font-size: 11px; font-weight: bold; background: #fff; }
        .pin-switch.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .edit-x { position: absolute; bottom: -18px; right: -18px; width: 20px; height: 20px; background: #000; color: #fff; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; z-index: 500; border: 2px solid #fff; }
        body.pinning-mode-active .edit-x { display: flex; }
        .admin-section { margin-bottom: 30px; }
        .admin-label { font-size: 10px; font-weight: 800; color: var(--grey); text-transform: uppercase; margin-bottom: 12px; display: block; }
        input, select, textarea { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 2px; font-size: 13px; box-sizing: border-box; margin-bottom: 10px; font-family: inherit; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 2px; font-weight: 700; cursor: pointer; transition: 0.3s; font-size: 11px; text-transform: uppercase; }
        .btn-black { background: #000; color: #fff; }
        .btn-accent { background: var(--accent); color: #fff; }
        
        /* EXPORT TEXTAREA */
        #export-output { display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 20000; background: white; padding: 40px; box-sizing: border-box; }

        /* --- MOBILE OPTIMIZATION --- */
        @media screen and (max-width: 768px) {
            #ui-mode-toggle { display: none !important; } /* モード切替を隠す */
            .nav-arrow { display: none !important; } /* 矢印を隠す */
            #admin-panel { display: none !important; } /* パネルを隠す */
            .location { display: none; } /* ヘッダーをスッキリさせる */
        }
    </style>
</head>
<body id="app-body">

<div id="ui-mode-toggle">
    <button id="mode-view" class="active" onclick="changeAppMode('view')">VIEW</button>
    <button id="mode-edit" onclick="changeAppMode('edit')">DESIGNER</button>
</div>

<header>
    <div class="brand-title">Palazzo Molteni Tokyo</div>
    <div class="location">Virtual Experience Suite</div>
</header>

<div class="nav-arrow arrow-left" onclick="navigateArea(-1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></div>
<div class="nav-arrow arrow-right" onclick="navigateArea(1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>

<div id="admin-panel">
    <div style="font-weight:900; letter-spacing:2px; font-size:14px; margin-bottom:40px; border-bottom:2px solid #000; padding-bottom:15px; text-transform:uppercase;">Administration</div>
    <div class="admin-section">
        <span class="admin-label">01. Area Management</span>
        <input type="text" id="new-area-name" placeholder="Area Name">
        <button class="btn btn-black" onclick="handleCreateArea()">Add Area to <span id="admin-f-label">1F</span></button>
    </div>
    <div id="edit-tools" style="display:none;">
        <div class="admin-section">
            <span class="admin-label">02. Media Content</span>
            <input type="file" id="file-input" accept="image/*">
            <input type="text" id="manual-url" placeholder="Paste Image URL" onchange="updateImageManual(this.value)">
            <span class="admin-label" style="margin-top:25px;">03. Interaction Settings</span>
            <div id="pin-switch-btn" class="pin-switch" onclick="handlePinToggle()">Placement Mode: OFF</div>
            <select id="marker-type">
                <option value="product">Product Link (◎)</option>
                <option value="detail">Interior Detail (▣)</option>
            </select>
        </div>
        <button class="btn btn-accent" onclick="commitChanges()">1. Save to Browser</button>
        <button class="btn btn-black" style="margin-top:10px;" onclick="exportPermanentHTML()">2. Export for GitHub</button>
        <button class="btn" style="margin-top:20px; font-size:9px; color:red;" onclick="handleDeleteArea()">Remove Area</button>
    </div>
</div>

<div id="export-output">
    <div style="max-width: 800px; margin: auto;">
        <h2 style="font-family: var(--bodoni);">Final Export</h2>
        <p style="font-size: 13px; color: #666;">Copy the code below, go to GitHub index.html, and replace EVERYTHING with this.</p>
        <textarea id="export-text" readonly style="height: 400px; font-size: 10px;"></textarea>
        <button class="btn btn-black" onclick="document.getElementById('export-output').style.display='none'">Back to App</button>
    </div>
</div>

<div id="viewport" onclick="handleViewportClick(event)">
    <div class="area-nav" id="area-nav"></div>
    <div id="scene-display"></div>
</div>

<footer>
    <div class="floor-btn" onclick="handleFloorChange('B1F')" id="f-B1F"><span class="floor-num">B1</span><span class="floor-label">Basement</span></div>
    <div class="floor-btn active" onclick="handleFloorChange('1F')" id="f-1F"><span class="floor-num">1F</span><span class="floor-label">Ground</span></div>
    <div class="floor-btn" onclick="handleFloorChange('2F')" id="f-2F"><span class="floor-num">2F</span><span class="floor-label">Living</span></div>
    <div class="floor-btn" onclick="handleFloorChange('3F')" id="f-3F"><span class="floor-num">3F</span><span class="floor-label">Apartment</span></div>
</footer>

<script>
    const API_KEY = "ddb8687d0558d57aad3e6155ccaab2e2";
    
    // --- 【超重要】ここがデータベースになります ---
    const DATA_ID = "pmt_master_v22";
    let store = JSON.parse(localStorage.getItem(DATA_ID)) || { 'B1F':[], '1F':[], '2F':[], '3F':[] };
    // ---------------------------------------------

    let floor = '1F';
    let areaId = null;
    let mode = 'view';
    let isPinning = false;
    let touchX = 0;

    window.onload = () => {
        // スマホ判定：横幅が狭い場合は強制VIEWモード
        if (window.innerWidth <= 768) {
            mode = 'view';
        }
        handleFloorChange('1F');
    };

    function changeAppMode(m) {
        if (window.innerWidth <= 768) return; // スマホでは変更不可
        mode = m; isPinning = false;
        document.getElementById('mode-view').className = (m === 'view' ? 'active' : '');
        document.getElementById('mode-edit').className = (m === 'edit' ? 'active' : '');
        document.getElementById('admin-panel').classList.toggle('open', m === 'edit');
        document.body.classList.remove('pinning-mode-active');
        renderActiveScene();
    }

    function handleViewportClick(e) {
        if (mode === 'edit' && !isPinning) {
            if (e.target.closest('.area-nav') || e.target.closest('.mol-hs')) return;
            changeAppMode('view');
            return;
        }
        if (mode === 'edit' && isPinning) {
            const stage = document.getElementById('scene-stage');
            if (stage && e.target.closest('#scene-stage') && !e.target.closest('.mol-hs')) {
                const r = stage.getBoundingClientRect();
                addPinAt(((e.clientX - r.left)/r.width)*100, ((e.clientY - r.top)/r.height)*100);
            }
        }
    }

    function handlePinToggle() {
        isPinning = !isPinning;
        const btn = document.getElementById('pin-switch-btn');
        btn.classList.toggle('active', isPinning);
        btn.innerText = isPinning ? "Placement Mode: ACTIVE" : "Placement Mode: OFF";
        document.body.classList.toggle('pinning-mode-active', isPinning);
    }

    function handleFloorChange(f) {
        floor = f;
        document.querySelectorAll('.floor-btn').forEach(el => el.classList.remove('active'));
        const btn = document.getElementById('f-'+f);
        if(btn) btn.classList.add('active');
        document.getElementById('admin-f-label').innerText = f;
        renderNavList();
    }

    function renderNavList() {
        const nav = document.getElementById('area-nav');
        nav.innerHTML = '';
        const list = store[floor];
        if(list.length === 0) {
            document.getElementById('scene-display').innerHTML = '<div class="empty-state">Palazzo Molteni Tokyo Experience.</div>';
            document.getElementById('edit-tools').style.display = 'none';
            return;
        }
        list.forEach(a => {
            const el = document.createElement('div');
            el.className = `area-item ${a.id === areaId ? 'active' : ''}`;
            el.id = `nav-${a.id}`;
            el.innerText = a.name;
            el.onclick = (e) => { e.stopPropagation(); selectActiveArea(a.id); };
            nav.appendChild(el);
        });
        if(!areaId || !list.find(x => x.id === areaId)) selectActiveArea(list[0].id);
        else selectAreaNav(areaId);
    }

    function selectActiveArea(id) {
        areaId = id;
        const a = store[floor].find(x => x.id === id);
        document.querySelectorAll('.area-item').forEach(el => el.classList.toggle('active', el.innerText === a.name));
        renderActiveScene();
        document.getElementById('edit-tools').style.display = (mode === 'edit' ? 'block' : 'none');
        document.getElementById('manual-url').value = a.img || '';
        selectAreaNav(id);
    }

    function selectAreaNav(id) {
        const activeNav = document.getElementById(`nav-${id}`);
        if(activeNav) activeNav.scrollIntoView({ behavior: 'smooth', inline: 'center' });
    }

    function renderActiveScene() {
        const a = store[floor].find(x => x.id === areaId);
        if(!a) return;
        let pinsHTML = '';
        a.pins.forEach(p => {
            const isP = p.type === 'product';
            const linkAttrs = isP ? `href="${p.link}" target="_blank"` : '';
            const xBtn = (mode === 'edit') ? `<div class="edit-x" onclick="handleDeletePin(event,'${p.id}')">×</div>` : '';
            pinsHTML += `
                <div class="mol-hs ${p.type==='detail'?'type-detail':''}" style="top:${p.y}%; left:${p.x}%;" onclick="handlePinInteraction(event, '${p.id}')">
                    ${xBtn}
                    <span class="mol-dot-outer"><span class="mol-dot-inner"></span></span>
                    <a ${linkAttrs} class="mol-card" ontouchstart="">
                        <strong>${p.title}</strong>
                        <span>${p.sub}</span>
                    </a>
                </div>`;
        });
        const container = document.getElementById('scene-display');
        container.innerHTML = `<div class="scene-wrap" id="scene-stage"><img src="${a.img || 'https://via.placeholder.com/1200x800?text=Awaiting+Visual'}">${pinsHTML}</div>`;
    }

    function navigateArea(dir) {
        if(mode === 'edit') return;
        const list = store[floor]; const idx = list.findIndex(x => x.id === areaId);
        const nextIdx = idx + dir;
        if (nextIdx >= 0 && nextIdx < list.length) selectActiveArea(list[nextIdx].id);
    }

    document.getElementById('viewport').addEventListener('touchstart', e => { touchX = e.touches[0].screenX; });
    document.getElementById('viewport').addEventListener('touchend', e => {
        if(mode === 'edit') return;
        const diff = e.changedTouches[0].screenX - touchX;
        if(Math.abs(diff) > 80) navigateArea(diff > 0 ? -1 : 1);
    });

    function handlePinInteraction(e, pid) {
        if (mode === 'edit') {
            e.stopPropagation();
            const p = store[floor].find(x => x.id === areaId).pins.find(x => x.id === pid);
            const nt = prompt("Update Title:", p.title);
            if (nt) {
                p.title = nt;
                if(p.type === 'product') p.link = prompt("Update URL:", p.link) || p.link;
                else p.sub = prompt("Update Description:", p.sub) || p.sub;
                renderActiveScene();
            }
        }
    }

    function handleDeletePin(e, pid) {
        e.stopPropagation();
        const a = store[floor].find(x => x.id === areaId);
        a.pins = a.pins.filter(x => x.id !== pid);
        renderActiveScene();
    }

    function addPinAt(x, y) {
        const t = document.getElementById('marker-type').value;
        const name = prompt("Title:"); if(!name) return;
        let l = "", s = "商品詳細はこちら >";
        if(t==='product') l = prompt("URL:", "https://"); else s = prompt("Detail:");
        store[floor].find(x => x.id === areaId).pins.push({ id:'p'+Date.now(), x, y, title:name, link:l, sub:s, type:t });
        renderActiveScene();
    }

    function handleCreateArea() {
        const n = document.getElementById('new-area-name').value; if(!n) return;
        const id = 'a' + Date.now();
        store[floor].push({ id, name: n, img: '', pins: [] });
        document.getElementById('new-area-name').value = '';
        commitChanges(true); renderNavList(); selectActiveArea(id);
    }

    function handleDeleteArea() {
        if(confirm('Delete area?')) {
            store[floor] = store[floor].filter(x => x.id !== areaId);
            areaId = null; commitChanges(true); renderNavList();
        }
    }

    function commitChanges(silent = false) {
        localStorage.setItem(DATA_ID, JSON.stringify(store));
        if(!silent) alert("Progress saved to browser memory.");
    }

    function updateImageManual(v) {
        const a = store[floor].find(x => x.id === areaId);
        if(a) { a.img = v; renderActiveScene(); }
    }

    document.getElementById('file-input').onchange = async (e) => {
        const f = e.target.files[0]; if(!f) return;
        const fd = new FormData(); fd.append("image", f);
        try {
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${API_KEY}`, { method: "POST", body: fd });
            const j = await res.json();
            if(j.success) { updateImageManual(j.data.url); document.getElementById('manual-url').value = j.data.url; }
        } catch(err) { alert("Upload Fail"); }
    };

    function exportPermanentHTML() {
        const currentData = JSON.stringify(store);
        let fullSource = document.documentElement.outerHTML;
        const regex = /let store = JSON\.parse\(localStorage\.getItem\(DATA_ID\)\) \|\| \{ 'B1F':\[\], '1F':\[\], '2F':\[\], '3F':\[\] \};/;
        const replacement = `let store = ${currentData};`;
        fullSource = fullSource.replace(regex, replacement);
        const exportDiv = document.getElementById('export-output');
        const exportText = document.getElementById('export-text');
        exportText.value = "<!DOCTYPE html>\n" + fullSource;
        exportDiv.style.display = 'block';
        exportText.select();
    }
</script>
</body>
</html>
